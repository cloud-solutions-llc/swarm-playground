version: "3.8"

services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.3.3
    command: ["--strict.perms=false"]
    hostname: "{{.Node.Hostname}}-filebeat"
    user: root
    networks:
      - internal
    labels:
      app: filebeat
      role: agent
      namespace: infra
    environment:
      - KIBANA_HOST=logs.kibana.int:5601
      - ELASTICSEARCH_HOST=storage.elasticsearch.int:9200
      - ELASTICSEARCH_USERNAME=${ELASTICSEARCH_USERNAME}
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    deploy:
      mode: global
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    volumes:
      - logstash-data:/usr/share/filebeat/data
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log/:/var/log/:ro
    configs:
      - source: filebeat-config
        target: /usr/share/filebeat/filebeat.yml
    env_file:
      - ${PWD}/../../.env

configs:
  filebeat-config:
    external: true

networks:
  internal:
    external: true

volumes:
  logstash-modules:
    driver: local
  logstash-data:
    driver: local